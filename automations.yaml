# Sunsynk Inclusions
# Added on 7 Aug 2025 @ 13h16 by JB
- id: '1717429630744'
  alias: Prepaid meter recharge
  description: ''
  trigger:
  - platform: state
    entity_id:
    - input_number.prepaid_meter_units
  condition:
  - condition: template
    value_template: '{{ states(''input_number.prepaid_meter_units'') | float > 0 }}'
  actions:
  - action: input_number.set_value
    metadata: {}
    data:
      value: '{{ ((states(''sensor.deyeinvertermaster_summary_total_grid_import_buy'') |
        float(6))  * 1000.0) }}'
    target:
      entity_id: input_number.prepaid_meter_inverter_total_units
  mode: single
  #-------------------------------------------------------------------------------
# GitHub commit
# Added on 20 aug 2025 @ 11h18 with Claude.ai
#- id: 'git_auto_commit'
#  alias: 'Auto Commit HA Config to GitHub'
#  description: 'Automatically commit Home Assistant configuration changes to GitHub'
#  trigger:
#    # Daily commit at 2 AM
#    - platform: time
#      at: '02:00:00'
#    # Commit after Home Assistant restarts (after 5 minutes uptime)
#    - platform: numeric_state
#      entity_id: sensor.uptime
#      above: 5
#  condition:
#    # Ensure Home Assistant has been running for at least 5 minutes
#    - condition: numeric_state
#      entity_id: sensor.uptime
#      above: 5
#  action:
#    - service: shell_command.git_commit
#      data: {}
#  mode: single
#-------------------------------------------------------------------------------  
# Sunsynk Inclusions
# Added on 7 Aug 2025 @ 13h16 by JB
- id: '1686299812078'
  alias: 'Inverter: Switch to Export essentials/Non-Essentials when sun sets/rises'
  description: This stops the export to non-essentials from the battery when the sun
    is not shining, but during the day solar power is sent to non-essentials
  trigger:
  - platform: sun
    event: sunset
    offset: -00:45:00
    id: poweressentials
  - platform: sun
    event: sunrise
    offset: 00:45:00
    id: powernonessentials
  condition: []
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id: poweressentials
      sequence:
      - action: select.select_option
        data:
          option: Essentials
        target:
          entity_id: select.deyeinvertermaster_load_limit_exp_ess_non_ess
    - conditions:
      - condition: trigger
        id: powernonessentials
      sequence:
      - action: select.select_option
        data:
          option: Zero Export
        target:
          entity_id: select.deyeinvertermaster_load_limit_exp_ess_non_ess
  mode: single

#-------------------------------------------------------------------------------
# Speedtest Review
#Added by Claude.ai on 21 Aug 2025  
- alias: 'Weekly Speed Test Review'
  trigger:
      - platform: time
        at: "09:00:00"
  condition:
        - condition: time
          weekday: [sun]
  action:
      - service: notify.email_alerts
        data:
          title: "Weekly Internet Performance Review"
          message: |
            Weekly Performance Summary:
            
            üìä This Week's Averages:
            ‚Ä¢ Download: {{ states('sensor.download_speed_24h_average') }} Mbps
            ‚Ä¢ Upload: {{ states('sensor.upload_speed_24h_average') }} Mbps
            ‚Ä¢ Quality Grade: {{ states('sensor.speedtest_connection_quality') }}
            
            üîç Recommendations:
            ‚Ä¢ Check Grafana for detailed trends
            ‚Ä¢ Review any alert patterns
            ‚Ä¢ Consider ISP contact if persistent issues
            
            üîó Dashboard: http://192.168.1.30:8123/lovelace/speedtest  
#-------------------------------------------------------------------------------
# Git Sync Monitoring and Automatic Backup
- alias: "GitHub Sync - Daily Backup"
  description: "Automatically commit and push configuration changes daily"
  trigger:
    - platform: time
      at: "02:00:00"  # Run at 2 AM daily
  action:
    - service: shell_command.git_commit
    - delay: "00:01:00"  # Wait 1 minute
    - service: notify.persistent_notification
      data:
        title: "GitHub Sync"
        message: "Daily backup completed at {{ now().strftime('%Y-%m-%d %H:%M:%S') }}"

- alias: "GitHub Sync - On Configuration Change"
  description: "Commit changes when important files are modified"
  trigger:
    - platform: event
      event_type: folder_watcher
      event_data:
        event_type: modified
        path: "/config/configuration.yaml"
    - platform: event
      event_type: folder_watcher
      event_data:
        event_type: modified
        path: "/config/automations.yaml"
    - platform: event
      event_type: folder_watcher
      event_data:
        event_type: modified
        path: "/config/scripts.yaml"
  action:
    - delay: "00:00:30"  # Wait 30 seconds for file writes to complete
    - service: shell_command.git_commit

- alias: "GitHub Sync - Notification on Failure"
  description: "Notify when git sync fails"
  trigger:
    - platform: event
      event_type: shell_command
      event_data:
        entity_id: shell_command.git_commit
        result: "error"
  action:
    - service: notify.persistent_notification
      data:
        title: "GitHub Sync Failed"
        message: "Failed to sync configuration to GitHub. Check logs for details."
        notification_id: "git_sync_failure"  